rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user has a specific role in the ROOT profiles collection
    function hasRoleRoot(role) {
      let p = /databases/$(database)/documents/profiles/$(request.auth.uid);
      return request.auth != null && exists(p) && get(p).data.role == role;
    }

    // Check if user has a specific role in the TESTDATA profiles collection
    function hasRoleTest(role) {
      let p = /databases/$(database)/documents/testdata/db/profiles/$(request.auth.uid);
      return request.auth != null && exists(p) && get(p).data.role == role;
    }

    // --- ROOT DATA RULES (Real Data) ---

    match /profiles/{userId} {
      allow read: if (request.auth != null && request.auth.uid == userId) || hasRoleRoot('admin');
      allow create, update: if request.auth != null && request.auth.uid == userId && request.resource.data.uid == userId;
      allow delete: if hasRoleRoot('admin');
    }

    match /newUsersQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRoleRoot('admin');
    }

    match /userPersonalDataQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRoleRoot('admin');
    }
    
    match /maskirQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRoleRoot('admin');
    }

    match /apartmentQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRoleRoot('admin');
    }

    match /apartments/{apartmentId} {
      allow read: if true;
      allow create, update: if hasRoleRoot('admin') || hasRoleRoot('maskir');
      allow delete: if hasRoleRoot('admin') || hasRoleRoot('maskir');
    }

    // --- TEST DATA RULES (testdata/db) ---
    
    match /testdata/db {
      
      match /profiles/{userId} {
        allow read: if (request.auth != null && request.auth.uid == userId) || hasRoleTest('admin');
        allow create, update: if request.auth != null && request.auth.uid == userId && request.resource.data.uid == userId;
        allow delete: if hasRoleTest('admin');
      }

      match /newUsersQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRoleTest('admin');
      }

      match /userPersonalDataQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRoleTest('admin');
      }
      
      match /maskirQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRoleTest('admin');
      }

      match /apartmentQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRoleTest('admin');
      }

      match /apartments/{apartmentId} {
        allow read: if true;
        allow create, update: if hasRoleTest('admin') || hasRoleTest('maskir');
        allow delete: if hasRoleTest('admin') || hasRoleTest('maskir');
      }
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
