rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user has a specific role in the ROOT profiles collection
    function hasRoleRoot(role) {
      let p = /databases/$(database)/documents/profiles/$(request.auth.uid);
      return request.auth != null && exists(p) && get(p).data.role == role;
    }

    // Check if user has a specific role in the TESTDATA profiles collection
    function hasRoleTest(role) {
      let p = /databases/$(database)/documents/testdata/db/profiles/$(request.auth.uid);
      return request.auth != null && exists(p) && get(p).data.role == role;
    }

    // Check if user has a specific role in EITHER root or test profiles
    function hasRole(role) {
      return hasRoleRoot(role) || hasRoleTest(role);
    }

    // --- ROOT DATA RULES (Real Data) ---

    match /profiles/{userId} {
      allow read: if (request.auth != null && request.auth.uid == userId) || hasRole('admin');
      allow create, update: if request.auth != null && request.auth.uid == userId && request.resource.data.uid == userId;
      allow delete: if hasRole('admin');
    }

    match /newUsersQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }

    match /userPersonalDataQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }
    
    match /maskirQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }

    match /apartmentQuestions/{questionId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }

    match /apartments/{apartmentId} {
      allow read: if true;
      allow create, update: if hasRole('admin') || hasRole('maskir');
      allow delete: if hasRole('admin') || hasRole('maskir');
    }

    match /israel_locations/{locationId} {
      allow read: if true;
      allow create, update, delete: if hasRole('admin');
    }

    match /groups/{groupId} {
      allow read: if request.auth != null && (request.auth.uid in resource.data.members || hasRole('admin'));
      allow create, update, delete: if hasRole('admin');
    }

    match /invitations/{invitationId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.inviteeId || hasRole('admin'));
      allow create: if hasRole('admin');
      allow update: if request.auth != null && (request.auth.uid == resource.data.inviteeId || hasRole('admin'));
      allow delete: if hasRole('admin');
    }

    // --- TEST DATA RULES (testdata/db) ---
    
    match /testdata/db {
      
      match /profiles/{userId} {
        allow read: if (request.auth != null && request.auth.uid == userId) || hasRole('admin');
        allow create, update: if (request.auth != null && request.auth.uid == userId && request.resource.data.uid == userId) || hasRole('admin');
        allow delete: if hasRole('admin');
      }

      match /newUsersQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRole('admin');
      }

      match /userPersonalDataQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRole('admin');
      }
      
      match /maskirQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRole('admin');
      }

      match /apartmentQuestions/{questionId} {
        allow read: if true;
        allow write: if hasRole('admin');
      }

      match /apartments/{apartmentId} {
        allow read: if true;
        allow create, update: if hasRole('admin') || hasRole('maskir');
        allow delete: if hasRole('admin') || hasRole('maskir');
      }

      match /israel_locations/{locationId} {
        allow read: if true;
        allow create, update, delete: if hasRole('admin');
      }

      match /groups/{groupId} {
        allow read: if request.auth != null && (request.auth.uid in resource.data.members || hasRole('admin'));
        allow create, update, delete: if hasRole('admin');
      }

      match /invitations/{invitationId} {
        allow read: if request.auth != null && (request.auth.uid == resource.data.inviteeId || hasRole('admin'));
        allow create: if hasRole('admin');
        allow update: if request.auth != null && (request.auth.uid == resource.data.inviteeId || hasRole('admin'));
        allow delete: if hasRole('admin');
      }
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
