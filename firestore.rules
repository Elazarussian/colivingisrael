rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      let uid = request.auth.uid;
      let rootProfile = /databases/$(database)/documents/profiles/$(uid);
      let testProfile = /databases/$(database)/documents/testdata/db/profiles/$(uid);
      return isSignedIn() && (
        (exists(rootProfile) && get(rootProfile).data.role == 'admin') ||
        (exists(testProfile) && get(testProfile).data.role == 'admin')
      );
    }

    match /groupProperties/{propId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /testdata/db/groupProperties/{propId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    function isAdminRoot() { return isAdmin(); }
    function isAdminTest() { return isAdmin(); }

    // Helper to check for a valid invite in the ROOT collection
    function hasInviteRoot(groupId) {
       return exists(/databases/$(database)/documents/groupInvites/$(request.auth.uid + '_' + groupId));
    }

    // Helper to check for a valid invite in the TESTDATA collection
    function hasInviteTest(groupId) {
       return exists(/databases/$(database)/documents/testdata/db/groupInvites/$(request.auth.uid + '_' + groupId));
    }

    // --- ROOT DATA ---

    match /profiles/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isAdminRoot();
    }

    match /groups/{groupId} {
      allow read: if isSignedIn();
      allow create: if isAdminRoot() || (isSignedIn() && request.resource.data.adminId == request.auth.uid);
      allow delete: if isAdminRoot() || (isSignedIn() && resource.data.adminId == request.auth.uid);

      // Allow creator to update or user to join if they have an invite
      allow update: if isAdminRoot()
        || (isSignedIn() && resource.data.adminId == request.auth.uid)
        || (
          isSignedIn()
          && request.resource.data.members.hasAny([request.auth.uid])
          && (
            exists(/databases/$(database)/documents/groupInvites/$(request.auth.uid + '_' + groupId)) ||
            exists(/databases/$(database)/documents/testdata/db/groupInvites/$(request.auth.uid + '_' + groupId))
          )
        );

      match /members/{memberUid} {
        allow read: if isSignedIn();

        allow create: if isSignedIn()
          && request.auth.uid == memberUid
          && request.resource.data.uid == memberUid
          && request.resource.data.inviteId is string;

        allow update: if false;
        allow delete: if isAdminRoot();
      }
    }

    match /groupInvites/{inviteId} {
      allow create: if isAdminRoot() || (
        isSignedIn()
        && request.resource.data.toUid == request.auth.uid
        && request.resource.data.inviterUid == request.auth.uid
      ) || (
        isSignedIn()
        && request.resource.data.inviterUid == request.auth.uid
        && get(/databases/$(database)/documents/groups/$(request.resource.data.groupId)).data.adminId == request.auth.uid
      );

      allow read: if isSignedIn()
        && (
          (resource != null && resource.data.toUid == request.auth.uid)
          || (resource != null && resource.data.inviterUid == request.auth.uid)
          || isAdminRoot()
          || (resource == null) // Allow checking for non-existent invites
        );

      allow delete: if isSignedIn()
        && (
          resource.data.toUid == request.auth.uid
          || resource.data.inviterUid == request.auth.uid
          || isAdminRoot()
        );

      allow update: if false;
    }



    // --- PUBLIC DATA ---

    match /newUsersQuestions/{id} {
      allow read: if true;
      allow write: if isAdminRoot();
    }

    match /userPersonalDataQuestions/{id} {
      allow read: if true;
      allow write: if isAdminRoot();
    }

    match /maskirQuestions/{id} {
      allow read: if true;
      allow write: if isAdminRoot();
    }

    match /apartmentQuestions/{id} {
      allow read: if true;
      allow write: if isAdminRoot();
    }

    match /apartments/{id} {
      allow read: if true;
      allow create, update, delete: if isAdminRoot();
    }

    match /israel_locations/{id} {
      allow read: if true;
      allow create, update, delete: if isAdminRoot();
    }

    // --- TEST DATA ---

    match /testdata/db {

      match /profiles/{userId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdminTest();
      }

      match /groups/{groupId} {
        allow read: if isSignedIn();
        allow create: if isAdminTest() || (isSignedIn() && request.resource.data.adminId == request.auth.uid);
        allow delete: if isAdminTest() || (isSignedIn() && resource.data.adminId == request.auth.uid);

        allow update: if isAdminTest()
          || (isSignedIn() && resource.data.adminId == request.auth.uid)
          || (
            isSignedIn()
            && request.resource.data.members.hasAny([request.auth.uid])
            && (
              exists(/databases/$(database)/documents/groupInvites/$(request.auth.uid + '_' + groupId)) ||
              exists(/databases/$(database)/documents/testdata/db/groupInvites/$(request.auth.uid + '_' + groupId))
            )
          );

        match /members/{memberUid} {
          allow read: if isSignedIn();

          allow create: if isSignedIn()
            && request.auth.uid == memberUid
            && request.resource.data.uid == memberUid
            && request.resource.data.inviteId is string;

          allow update: if false;
          allow delete: if isAdminTest();
        }
      }

      match /groupInvites/{inviteId} {
        allow create: if isAdminTest() || (
          isSignedIn()
          && request.resource.data.toUid == request.auth.uid
          && request.resource.data.inviterUid == request.auth.uid
        ) || (
          isSignedIn()
          && request.resource.data.inviterUid == request.auth.uid
          && get(/databases/$(database)/documents/testdata/db/groups/$(request.resource.data.groupId)).data.adminId == request.auth.uid
        );

        allow read: if isSignedIn()
          && (
            (resource != null && resource.data.toUid == request.auth.uid)
            || (resource != null && resource.data.inviterUid == request.auth.uid)
            || isAdminTest()
            || (resource == null) // Allow checking for non-existent invites
          );

        allow delete: if isSignedIn()
          && (
            resource.data.toUid == request.auth.uid
            || resource.data.inviterUid == request.auth.uid
            || isAdminTest()
          );

        allow update: if false;
      }


    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
