<section class="search-groups-dashboard single-column"
  style="direction: rtl; min-height: calc(100vh - 80px); display: flex; flex-direction: column; gap: 2rem; padding: 2rem 1rem;">

  <!-- Content Wrapper -->
  <div class="container main-container">

    <!-- Restricted Access Message for ALL Group Members -->
    <section class="info-section" *ngIf="selectedGroup">
      <div class="glass-alert">
        <span class="material-symbols-outlined icon-lg">group_off</span>
        <div class="alert-content">
          <h3>הינך כבר חבר\ה בקבוצה קיימת</h3>
          <p>על מנת לחפש שותפים או ליצור קבוצה עליך לצאת מהקבוצה שהינך נמצא בה.</p>
          <p class="hint">ניתן לצאת מהקבוצה דרך דף הפרופיל האישי.</p>
        </div>
      </div>
    </section>

    <!-- Top Controls: Selection for Admin & Create Group for non-members -->
    <header class="dashboard-controls" (click)="$event.stopPropagation()">
      <div class="controls-wrapper glass-panel" *ngIf="auth.isAdmin(profile) || groups.length === 0">

        <!-- Group Selector (ONLY for Admins) -->
        <div class="groups-nav" *ngIf="auth.isAdmin(profile) && groups.length > 0">
          <label class="nav-label">ניהול מערכת - בחר קבוצה:</label>
          <div class="groups-chips">
            <button *ngFor="let g of groups" class="group-chip" [class.active]="selectedGroup?.id === g.id"
              (click)="selectGroup(g, $event)">
              <span class="material-symbols-outlined">group</span>
              {{ g.name }}
            </button>
          </div>
        </div>

        <!-- Create Group (Only for non-members or admins) -->
        <div class="group-create-action" *ngIf="auth.isAdmin(profile) || groups.length === 0">
          <div class="input-group-premium">
            <label class="control-label">מספר שותפים דרוש:</label>
            <input type="number" [(ngModel)]="newGroupRequiredMembers" min="2" max="10" class="input-main input-short">
            <button class="btn btn-special" (click)="createGroup()">
              <span class="material-symbols-outlined">add_circle</span>
              צור קבוצה
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="management-grid" *ngIf="!loading; else loader">

      <!-- Section: Active Group Content (Name, Members) -->
      <main class="management-main glass-panel" *ngIf="selectedGroup" (click)="$event.stopPropagation()">
        <header class="group-detail-header">
          <div class="header-main-info">
            <div class="title-with-actions">
              <h2>
                {{ (auth.isAdmin(profile) || selectedGroup.adminId === profile?.uid) ? 'ניהול קבוצה:' : 'פרטי קבוצה:' }}
                <span class="highlight">{{ selectedGroup.name }}</span>
              </h2>
              <button class="btn btn-danger btn-sm"
                *ngIf="auth.isAdmin(profile) || selectedGroup.adminId === profile?.uid"
                (click)="deleteGroup(selectedGroup)" title="מחק קבוצה">
                <span class="material-symbols-outlined">delete</span> מחק קבוצה
              </button>
              <button class="btn btn-sm btn-invite-link"
                *ngIf="auth.isAdmin(profile) || selectedGroup.adminId === profile?.uid"
                [class.success]="inviteCopySuccess" (click)="copyInviteLink()" title="העתק קישור הזמנה מהיר">
                <span class="material-symbols-outlined">
                  {{ inviteCopySuccess ? 'check_circle' : 'person_add' }}
                </span>
                {{ inviteCopySuccess ? 'הקישור הועתק!' : 'הזמן חברים לקבוצה' }}
              </button>
              <!-- Leave Group for invited users -->
              <button class="btn btn-outline btn-sm"
                *ngIf="!auth.isAdmin(profile) && selectedGroup.adminId !== profile?.uid"
                (click)="leaveGroup(selectedGroup)" title="צא מהקבוצה">
                <span class="material-symbols-outlined">exit_to_app</span> צא מהקבוצה
              </button>
            </div>

            <div class="group-meta-bar">
              <span class="meta-item">
                <span class="material-symbols-outlined">person</span>
                נוצרה ע"י: <strong>{{ selectedGroup.creatorName || 'אנונימי' }}</strong>
              </span>
              <span class="meta-item">
                <span class="material-symbols-outlined">calendar_today</span>
                בתאריך: <strong>{{ selectedGroup.createdAt?.toDate() | date:'dd/MM/yyyy' }}</strong>
              </span>
              <span class="meta-item" *ngIf="auth.isAdmin(profile) || selectedGroup.adminId === profile?.uid">
                <span class="material-symbols-outlined">groups_2</span>
                שותפים דרושים:
                <input type="number" [ngModel]="selectedGroup.requiredMembers || 2"
                  (ngModelChange)="updateRequiredMembers($event)" min="2" max="10" class="input-inline-sm">
              </span>
              <span class="meta-item" *ngIf="!auth.isAdmin(profile) && selectedGroup.adminId !== profile?.uid">
                <span class="material-symbols-outlined">groups_2</span>
                שותפים דרושים: <strong>{{ selectedGroup.requiredMembers || 2 }}</strong>
              </span>
            </div>
          </div>
        </header>

        <!-- Group Members List -->
        <section class="management-section">
          <div class="section-header">
            <span class="material-symbols-outlined">diversity_3</span>
            <h3>חברי הקבוצה ({{ selectedGroupMembers.length }})</h3>
          </div>
          <div class="members-grid">
            <div class="member-mini-card" *ngFor="let member of selectedGroupMembers">
              <div class="avatar avatar-md">
                {{ (member.displayName || 'U')[0].toUpperCase() }}
              </div>
              <div class="member-details">
                <span class="name">{{ member.displayName || 'משתמש' }}</span>
                <span class="email">{{ member.email }}</span>
                <span class="joined-at" *ngIf="selectedGroup.membersJoinedAt?.[member.id || member.uid]">
                  {{ selectedGroup.membersJoinedAt?.[member.id || member.uid]?.toDate() | date:'dd/MM/yyyy HH:mm' }}
                </span>
              </div>
              <!-- Remove Member restricted to creator/admin -->
              <button class="btn-icon btn-remove" *ngIf="auth.isAdmin(profile) || selectedGroup.adminId === profile.uid"
                (click)="removeMember(member)" title="הסר מהקבוצה">
                <span class="material-symbols-outlined">person_remove</span>
              </button>
            </div>
          </div>
        </section>
      </main>

      <!-- Section: Discover Users (ONLY if Admin) -->
      <section class="management-section" *ngIf="auth.isAdmin(profile)" (click)="$event.stopPropagation()">
        <div class="glass-search-header">
          <div class="section-header">
            <span class="material-symbols-outlined">person_add</span>
            <h3>כל המשתתפים</h3>
          </div>
          <div class="global-search-bar">
            <span class="material-symbols-outlined">search</span>
            <input type="text" [(ngModel)]="searchTerm" (input)="filterUsers()"
              placeholder="חפש משתמשים לפי שם או אימייל..." class="search-input">
          </div>
        </div>

        <div class="users-grid">
          <div class="user-card glass-card" *ngFor="let user of availableUsers"
            [class.expanded]="expandedUserId === (user.id || user.uid) || closingUserId === (user.id || user.uid)">
            <div class="card-content">
              <div class="avatar avatar-lg">
                {{ (user.displayName || 'U')[0].toUpperCase() }}
              </div>
              <div class="user-main-info">
                <h3>{{ user.displayName || 'משתמש ללא שם' }}</h3>
                <p class="text-muted">{{ user.email }}</p>
                <!-- Group Membership Badge -->
                <div class="badge badge-blue" *ngIf="getUserGroup(user) as g">
                  <span class="material-symbols-outlined">group</span>
                  {{ g.name }}
                </div>

              </div>
              <!-- Actions hidden if in a group (already handled by outer *ngIf, but safe to keep) -->
              <div class="user-actions-ui"
                *ngIf="selectedGroup && (auth.isAdmin(profile) || selectedGroup.adminId === profile?.uid)">
                <ng-container *ngIf="!hasPendingInvite(user); else inviteSentBadge">
                  <button class="btn btn-outline btn-sm" (click)="inviteToGroup(user)">הזמן</button>
                  <button class="btn btn-special btn-sm" *ngIf="auth.isAdmin(profile)"
                    (click)="addToGroup(user)">הוסף</button>
                </ng-container>
                <ng-template #inviteSentBadge>
                  <div style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;">
                    <div class="badge badge-yellow">
                      <span class="material-symbols-outlined">mark_email_read</span>
                      הזמנה נשלחה
                    </div>
                    <button class="btn btn-outline btn-sm" (click)="cancelInvite(user)">בטל הזמנה</button>
                  </div>
                </ng-template>


              </div>
            </div>
            <div class="card-footer">
              <button class="btn-text" (click)="toggleQuickView(user.id || user.uid)">
                <span class="material-symbols-outlined">{{ expandedUserId === (user.id || user.uid) ? 'expand_less' :
                  'visibility' }}</span>
                {{ expandedUserId === (user.id || user.uid) ? 'סגור תצוגה' : 'תצוגה מהירה' }}
              </button>
            </div>

            <!-- Inline Unfolding Content -->
            <div class="user-card-unfurl" [class.expanded]="expandedUserId === (user.id || user.uid)">
              <div class="unfurl-inner">
                <div class="unfurl-content-wrapper"
                  *ngIf="expandedUserId === (user.id || user.uid) || closingUserId === (user.id || user.uid)">
                  <app-questions-manager mode="view-answers" [userId]="user.id || user.uid"
                    [onlyPersonalQuestions]="true" (closed)="toggleQuickView(user.id || user.uid)">
                  </app-questions-manager>
                  <div class="unfurl-footer">
                    <button class="btn btn-outline btn-sm" (click)="toggleQuickView(user.id || user.uid)">
                      <span class="material-symbols-outlined">expand_less</span> סגור תצוגה
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="availableUsers.length === 0" class="empty-state">
          <p>לא נמצאו משתמשים נוספים.</p>
        </div>
      </section>
    </div>

    <!-- Empty State for Users without any content -->
    <div *ngIf="!loading && groups.length === 0 && availableUsers.length === 0" class="empty-list container">
      <p>אין משתמשים או קבוצות להצגה כרגע.</p>
    </div>

    <ng-template #loader>
      <div class="loader-container">
        <div class="spinner"></div>
        <p>מעדכן נתונים...</p>
      </div>
    </ng-template>

    <!-- Direct Invite Modal -->
    <div *ngIf="directInviteGroup" class="confirm-modal-overlay">
      <div class="confirm-modal glass-morphism">
        <header class="modal-header">
          <span class="material-symbols-outlined icon-xl text-gradient">group_add</span>
          <h2>הזמנה לקבוצה: <span class="highlight">{{ directInviteGroup.name }}</span></h2>
        </header>

        <div class="modal-body" style="margin: 1.5rem 0; text-align: center;">
          <p>הוזמנת להצטרף לקבוצה על ידי שיתוף קישור.</p>
          <div class="group-info-card"
            style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.25rem; margin: 1rem 0; text-align: right;">
            <div class="info-row"
              style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; color: #fff;">
              <span class="material-symbols-outlined" style="color: #4CAF50;">person</span>
              <span>מנהל הקבוצה: <strong>{{ directInviteGroup.creatorName }}</strong></span>
            </div>
            <div class="info-row" style="display: flex; align-items: center; gap: 0.75rem; color: #fff;">
              <span class="material-symbols-outlined" style="color: #4CAF50;">groups</span>
              <span>מספר חברים נוכחי: <strong>{{ directInviteGroup.members.length }}</strong></span>
            </div>
          </div>
          <p class="question" style="font-weight: 600; color: #fff;">האם ברצונך לקבל את ההזמנה ולהצטרף לקבוצה?</p>
        </div>

        <div class="confirm-actions">
          <button class="btn btn-approve" (click)="acceptDirectInvite()">
            <span class="material-symbols-outlined">check_circle</span>
            אשר והצטרף
          </button>
          <button class="btn btn-outline" (click)="closeDirectInvite()">
            <span class="material-symbols-outlined">cancel</span>
            דחה הזמנה
          </button>
        </div>
      </div>
    </div>
  </div>
</section>