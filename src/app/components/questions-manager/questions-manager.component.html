<div class="questions-manager-container">

    <!-- === SHARED TEMPLATES === -->

    <!-- Language Switcher -->
    <ng-template #langSwitcher>
        <div class="language-switcher" style="display:flex;gap:0.5rem;margin-bottom:0.8rem;">
            <span (click)="setLanguage('he')" [style.opacity]="currentLang==='he'?1:0.5" class="lang-flag">🇮🇱</span>
            <span (click)="setLanguage('en')" [style.opacity]="currentLang==='en'?1:0.5" class="lang-flag">🇺🇸</span>
            <span (click)="setLanguage('ru')" [style.opacity]="currentLang==='ru'?1:0.5" class="lang-flag">🇷🇺</span>
            <span (click)="setLanguage('fr')" [style.opacity]="currentLang==='fr'?1:0.5" class="lang-flag">🇫🇷</span>
        </div>
    </ng-template>

    <!-- Question Preview (List Item) -->
    <ng-template #questionItem let-q let-i="index" let-listLen="listLen" let-moveUpFn="moveUpFn"
        let-moveDownFn="moveDownFn" let-openEditFn="openEditFn" let-deleteFn="deleteFn"
        let-showImportance="showImportance" let-moveArgs="moveArgs" let-openArgs="openArgs"
        let-togglePublicFn="togglePublicFn">
        <div class="question-item glass-card">
            <div class="question-info">
                <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom: 0.25rem;">
                    <strong>{{q.text}}</strong>
                    <span class="badge"
                        [style.background]="q.public !== false ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 255, 255, 0.05)'"
                        [style.color]="q.public !== false ? '#4caf50' : '#888'"
                        style="font-size:0.7rem; padding: 2px 6px; border-radius: 4px;">
                        {{ q.public !== false ? 'גלוי לכולם' : 'לא גלוי' }}
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span *ngIf="q.key" style="font-size:0.8rem;color:#666;">(Key: {{q.key}})</span>
                    <span class="question-type" style="font-size:0.8rem; opacity: 0.6;">({{q.type}})</span>
                </div>
                <ng-container *ngTemplateOutlet="optionsPreview; context: { $implicit: q }"></ng-container>
            </div>
            <div class="question-actions">
                <button class="btn btn-regular btn-sm" (click)="moveUpFn(i, moveArgs?.a, moveArgs?.b, moveArgs?.c)"
                    [disabled]="i === 0" title="העלה">↑</button>

                <button class="btn btn-regular btn-sm" (click)="moveDownFn(i, moveArgs?.a, moveArgs?.b, moveArgs?.c)"
                    [disabled]="i === listLen - 1" title="הורד">↓</button>

                <button class="public-toggle-btn" [class.active]="q.public !== false"
                    (click)="togglePublicFn(q, moveArgs?.a, moveArgs?.b, moveArgs?.c)"
                    [title]="q.public !== false ? 'התשובה גלויה לכולם' : 'התשובה פרטית למשתמש'">
                    <span class="material-symbols-outlined" style="font-size: 1.2rem;">{{ q.public !== false ?
                        'visibility' : 'visibility_off' }}</span>
                    <span class="btn-label">{{ q.public !== false ? 'גלוי' : 'לא גלוי' }}</span>
                </button>

                <button *ngIf="!q.permanent" class="btn btn-special btn-sm"
                    (click)="openEditFn(q, openArgs?.a, openArgs?.b, openArgs?.c)">ערוך</button>

                <span *ngIf="q.permanent" class="permanent-badge">שאלה קבועה</span>

                <button *ngIf="!q.permanent" class="btn btn-cancel btn-sm" (click)="deleteFn(q.id || '')">מחק</button>
            </div>
        </div>
    </ng-template>

    <!-- Add Question Form -->
    <ng-template #addQuestionForm let-model="model" let-addOptFn="addOptFn" let-removeOptFn="removeOptFn"
        let-addFn="addFn" let-keyManualMode="keyManualMode" let-toggleKeyFn="toggleKeyFn"
        let-showImportance="showImportance" let-minmaxProps="minmaxProps">
        <div class="add-question-form">
            <h3>הוסף שאלה חדשה</h3>
            <ng-container *ngTemplateOutlet="langSwitcher"></ng-container>

            <label>נוסח השאלה ({{currentLang | uppercase}})</label>
            <input *ngIf="currentLang === 'he'" [(ngModel)]="model.text"
                (input)="onQuestionTextChange(minmaxProps?.flag1, minmaxProps?.flag2, minmaxProps?.flag3)"
                class="form-control input-long" placeholder="הכנס שאלה (עברית)..." />
            <input *ngIf="currentLang === 'en'" [(ngModel)]="model.textEn"
                (input)="onQuestionTextChange(minmaxProps?.flag1, minmaxProps?.flag2, minmaxProps?.flag3)"
                class="form-control input-long" placeholder="Enter question (English)..." />
            <input *ngIf="currentLang === 'ru'" [(ngModel)]="model.textRu"
                (input)="onQuestionTextChange(minmaxProps?.flag1, minmaxProps?.flag2, minmaxProps?.flag3)"
                class="form-control input-long" placeholder="Введите вопрос (Russian)..." />
            <input *ngIf="currentLang === 'fr'" [(ngModel)]="model.textFr"
                (input)="onQuestionTextChange(minmaxProps?.flag1, minmaxProps?.flag2, minmaxProps?.flag3)"
                class="form-control input-long" placeholder="Entrez la question (French)..." />

            <div class="key-section-container" style="margin-top: 1rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                    <label [style.opacity]="(keyManualMode) ? 1 : 0.5">מפתח (אנגלית) - אופציונלי</label>
                    <label style="font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;cursor:pointer;">
                        <input type="checkbox" [checked]="(keyManualMode)"
                            (change)="toggleKeyFn(minmaxProps?.flag1, minmaxProps?.flag2, minmaxProps?.flag3)"> ערוך
                        ידנית
                    </label>
                </div>
                <input [(ngModel)]="model.key" [disabled]="!(keyManualMode)" class="form-control input-short"
                    [style.opacity]="(keyManualMode) ? 1 : 0.5" placeholder="לדוגמה: firstname" />

                <div class="permanent-danger-toggle" [class.active]="model.permanent"
                    (click)="model.permanent = !model.permanent; onPermanentCheckboxChanged(model.permanent)">
                    <div class="checkbox-custom">
                        <span class="material-symbols-outlined">done</span>
                    </div>
                    <span class="toggle-label">סמן כשאלה קבועה (בלתי ניתנת למחיקה)</span>
                </div>

                <div class="visibility-toggle" [class.active]="model.public" (click)="model.public = !model.public">
                    <div class="switch-track">
                        <div class="switch-thumb">
                            <span class="material-symbols-outlined">{{ model.public ? 'visibility' : 'visibility_off'
                                }}</span>
                        </div>
                    </div>
                    <div class="toggle-info">
                        <span class="toggle-title">נראות התשובה</span>
                        <span class="toggle-desc">{{ model.public ? 'הצג תשובה לכל המשתמשים (גלוי לכולם)' : 'שמור תשובה
                            כפרטית' }}</span>
                    </div>
                </div>
            </div>

            <label style="margin-top: 1rem;">סוג תשובה</label>
            <select [(ngModel)]="model.type" class="form-control input-long">
                <option value="text">טקסט חופשי</option>
                <option value="yesno">כן/לא</option>
                <option value="checklist">רשימת אפשרויות</option>
                <option value="date">תאריך</option>
                <option value="scale">דירוג</option>
                <option value="range">טווח מספרים</option>
                <option value="radio">בחירה יחידה</option>
                <option value="phone">טלפון</option>
                <option value="city_neighborhood">עיר ושכונה</option>
            </select>

            <div *ngIf="model.type === 'checklist' || model.type === 'radio'" class="options-manager"
                style="margin-top: 1rem;">
                <label>אפשרויות בחירה</label>
                <div class="add-option-row" style="margin-top: 0.5rem;">
                    <input #optInput class="form-control" style="flex:1" placeholder="אפשרות חדשה..."
                        (keyup.enter)="addOptFn(optInput.value); optInput.value=''" />
                    <button class="btn btn-special btn-sm"
                        (click)="addOptFn(optInput.value); optInput.value=''">הוסף</button>
                </div>
                <ul class="options-list" style="margin-top: 0.5rem;">
                    <li *ngFor="let opt of model.options; let i = index">{{opt}} <span class="remove-opt"
                            (click)="removeOptFn(i)">x</span></li>
                </ul>
            </div>

            <div *ngIf="model.type === 'scale' || model.type === 'range'" class="scale-manager"
                style="display:flex;gap:1rem;margin-top:1rem;">
                <div style="flex: 1;"><label>מינימום</label><input type="number" [(ngModel)]="model.min"
                        class="form-control" /></div>
                <div style="flex: 1;"><label>מקסימום</label><input type="number" [(ngModel)]="model.max"
                        class="form-control" /></div>
            </div>

            <div *ngIf="model.type === 'checklist'" class="max-selections-manager" style="margin-top:1rem;">
                <label>מקסימום בחירות (אופציונלי)</label>
                <input type="number" [(ngModel)]="model.maxSelections" class="form-control input-short"
                    placeholder="ללא הגבלה" min="1" />
                <small style="color:#666;display:block;margin-top:0.25rem;">הגבל את מספר האפשרויות שהמשתמש יכול
                    לבחור</small>
            </div>

            <button class="btn btn-approve btn-fit-content" style="margin-top: 1.5rem;" (click)="addFn()"
                [disabled]="!model.text">הוסף שאלה</button>
        </div>
    </ng-template>

    <!-- Options Preview -->
    <ng-template #optionsPreview let-q>
        <div *ngIf="(q.type === 'checklist' || q.type === 'radio') && q.options?.length" class="options-preview"
            style="margin-top: 4px;">
            <small style="opacity: 0.7;">אפשרויות: {{ q.options.join(', ') }}</small>
        </div>
        <div *ngIf="q.type === 'scale' || q.type === 'range'" class="options-preview" style="margin-top: 4px;">
            <small style="opacity: 0.7;">טווח: {{q.min}} - {{q.max}}</small>
        </div>
    </ng-template>

    <!-- Answer Input (For Questionnaires) -->
    <ng-template #answerInput let-q let-model="model">
        <div class="answer-input-container">
            <div *ngIf="q.type === 'text'">
                <input #textInput type="text" [(ngModel)]="model[q.id || '']" class="form-control input-long"
                    placeholder="התשובה שלך..." />
            </div>

            <div *ngIf="q.type === 'yesno'" class="yesno-buttons" style="display:flex;gap:1rem;justify-content:center;">
                <button class="btn" [class.btn-approve]="model[q.id || ''] === true"
                    (click)="model[q.id || ''] = true">כן</button>
                <button class="btn" [class.btn-cancel]="model[q.id || ''] === false"
                    (click)="model[q.id || ''] = false">לא</button>
            </div>

            <div *ngIf="q.type === 'checklist'"
                [ngClass]="{'checklist-options': true, 'two-column-options': q.options?.length > 5}">
                <div *ngIf="q.maxSelections" style="margin-bottom:0.75rem;color:#666;font-size:0.9rem;">(ניתן לבחור עד
                    {{q.maxSelections}} אפשרויות)</div>
                <div *ngFor="let opt of q.options" class="checkbox-item" style="margin-bottom:0.6rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="checkbox" [checked]="model[q.id || '']?.includes(opt)"
                            (change)="model[q.id || ''] = toggleChecklist(model[q.id || ''], opt, q.maxSelections)"> {{
                        opt }}
                    </label>
                </div>
            </div>

            <div *ngIf="q.type === 'radio'"
                [ngClass]="{'radio-options': true, 'two-column-options': q.options?.length > 5}">
                <div *ngFor="let opt of q.options" class="radio-item" style="margin-bottom:0.6rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="radio" [name]="q.id || ''" [value]="opt" [(ngModel)]="model[q.id || '']"> {{ opt }}
                    </label>
                </div>
            </div>

            <div *ngIf="q.type === 'date'">
                <input type="date" [(ngModel)]="model[q.id || '']" class="form-control input-short">
            </div>

            <div *ngIf="q.type === 'phone'" class="phone-input"
                style="display:flex;gap:0.5rem;justify-content:center;direction:ltr;">
                <select [ngModel]="getPhonePrefix(model[q.id || ''])"
                    (ngModelChange)="updatePhoneAnswer(q.id || '', 'prefix', $event, model)" class="form-control"
                    style="width: auto;">
                    <option *ngFor="let p of phonePrefixes" [value]="p">{{p}}</option>
                </select>
                <input type="text" [ngModel]="getPhoneNumber(model[q.id || ''])"
                    (ngModelChange)="updatePhoneAnswer(q.id || '', 'number', $event, model)" class="form-control"
                    placeholder="Number" style="flex:1" maxlength="7" />
            </div>

            <div *ngIf="q.type === 'city_neighborhood'" style="display:flex;flex-direction:column;gap:0.8rem;">
                <div class="autocomplete" style="position:relative;">
                    <div style="display:flex;align-items:center;gap:0.4rem;">
                        <input #cityInput autocomplete="off" class="form-control" style="flex: 1;"
                            [class.input-error]="cityValidationErrors[q.id || '']"
                            [value]="getOrInitAnswer(model,q).cityName || ''"
                            (input)="onCityInput(q, model, $any($event.target).value)" (blur)="onCityBlur(q, model)"
                            placeholder="הכנס שם עיר" />
                        <button type="button" class="btn btn-special btn-sm" (click)="toggleShowAllCities(q)">▾</button>
                    </div>
                    <ul *ngIf="citySuggestions[q.id || '']?.length" class="suggestions-list"
                        style="position: absolute; width: 100%; z-index: 10;">
                        <li *ngFor="let c of citySuggestions[q.id || '']" (mousedown)="onCitySelect(q, model, c)"
                            class="suggestion-item">
                            <span>{{ c.name }}</span>
                        </li>
                    </ul>
                    <div *ngIf="cityValidationErrors[q.id || '']" class="input-error-text">{{ cityValidationErrors[q.id
                        || ''] }}</div>
                </div>

                <div class="autocomplete" *ngIf="getOrInitAnswer(model,q).cityId" style="position:relative;">
                    <input #nbInput autocomplete="off" class="form-control"
                        [value]="getOrInitAnswer(model,q).neighborhoodName || ''"
                        (input)="onNeighborhoodInput(q, model, $any($event.target).value)"
                        (blur)="onNeighborhoodBlur(q, model)" placeholder="הכנס שם שכונה (אופציונלי)" />
                    <ul *ngIf="neighborhoodSuggestions[q.id || '']?.length" class="suggestions-list"
                        style="position: absolute; width: 100%; z-index: 10;">
                        <li *ngFor="let n of neighborhoodSuggestions[q.id || '']"
                            (mousedown)="onNeighborhoodSelect(q, model, n)" class="suggestion-item">
                            <span>{{ n }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div *ngIf="q.type === 'scale'" class="scale-input" style="text-align:center;">
                <input type="range" class="input-long" [min]="q.min || 1" [max]="q.max || 5"
                    [(ngModel)]="model[q.id || '']" style="width:100%">
                <div class="scale-value" style="font-size:1.4rem; font-weight:bold; margin-top:0.5rem; color: #4caf50;">
                    {{ model[q.id || ''] }}</div>
            </div>

            <div *ngIf="q.type === 'range'" class="range-input">
                <div class="range-inputs" style="display:flex;align-items:center;gap:1.5rem;justify-content:center;">
                    <div style="display:flex; flex-direction: column; align-items:center;">
                        <label style="font-size: 0.8rem; margin-bottom: 4px; opacity: 0.7;">מינימום</label>
                        <input type="number" [(ngModel)]="ensureRangeAnswer(model, q).min" [min]="q.min || 0"
                            [max]="q.max || 100" class="form-control" style="width: 80px;">
                    </div>
                    <div style="display:flex; flex-direction: column; align-items:center;">
                        <label style="font-size: 0.8rem; margin-bottom: 4px; opacity: 0.7;">מקסימום</label>
                        <input type="number" [(ngModel)]="ensureRangeAnswer(model, q).max" [min]="q.min || 0"
                            [max]="q.max || 100" class="form-control" style="width: 80px;">
                    </div>
                </div>
                <div style="text-align:center; margin-top:0.8rem; color:#888;"><small>טווח אפשרי: {{q.min || 0}} -
                        {{q.max || 100}}</small></div>
            </div>
        </div>
    </ng-template>


    <!-- === ADMIN MODALS === -->

    <!-- Registration Questions -->
    <div *ngIf="mode === 'admin-registration'" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ניהול שאלות הרשמה</h2>
                <button class="btn-close" (click)="close()">X</button>
            </div>
            <div class="modal-body">
                <div class="questions-list">
                    <h3>שאלות קיימות</h3>
                    <div *ngIf="!questions.length" style="opacity: 0.6; padding: 1rem;">אין שאלות עדיין.</div>
                    <ng-container *ngFor="let q of questions; let i = index">
                        <ng-container
                            *ngTemplateOutlet="questionItem; context: { $implicit: q, index: i, listLen: questions.length, moveUpFn: moveQuestionUp.bind(this), moveDownFn: moveQuestionDown.bind(this), openEditFn: openEditQuestion.bind(this), deleteFn: deleteQuestion.bind(this), togglePublicFn: toggleQuestionPublic.bind(this), showImportance: false, moveArgs: { a: false }, openArgs: { a: false } }"></ng-container>
                    </ng-container>
                </div>
                <hr style="margin: 2rem 0; opacity: 0.1;">
                <ng-container
                    *ngTemplateOutlet="addQuestionForm; context: { model: newQuestion, addOptFn: addOption.bind(this), removeOptFn: removeOption.bind(this), addFn: addQuestion.bind(this), keyManualMode: registrationKeyManualMode, toggleKeyFn: toggleKeyManualMode.bind(this), showImportance: false, minmaxProps: { flag1: false } }"></ng-container>
            </div>
        </div>
    </div>

    <!-- Personal Data Questions -->
    <div *ngIf="mode === 'admin-personal-data'" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ניהול שאלון פרטי משתמש</h2>
                <button class="btn-close" (click)="close()">X</button>
            </div>
            <div class="modal-body">
                <div class="questions-list">
                    <h3>שאלות קיימות</h3>
                    <div *ngIf="!personalDataQuestions.length" style="opacity: 0.6; padding: 1rem;">אין שאלות עדיין.
                    </div>
                    <ng-container *ngFor="let q of personalDataQuestions; let i = index">
                        <ng-container
                            *ngTemplateOutlet="questionItem; context: { $implicit: q, index: i, listLen: personalDataQuestions.length, moveUpFn: moveQuestionUp.bind(this), moveDownFn: moveQuestionDown.bind(this), openEditFn: openEditQuestion.bind(this), deleteFn: deletePersonalDataQuestion.bind(this), togglePublicFn: toggleQuestionPublic.bind(this), showImportance: true, moveArgs: { a: true }, openArgs: { a: true } }"></ng-container>
                    </ng-container>
                </div>
                <hr style="margin: 2rem 0; opacity: 0.1;">
                <ng-container
                    *ngTemplateOutlet="addQuestionForm; context: { model: newPersonalDataQuestion, addOptFn: addPersonalDataOption.bind(this), removeOptFn: removePersonalDataOption.bind(this), addFn: addPersonalDataQuestion.bind(this), keyManualMode: personalDataKeyManualMode, toggleKeyFn: toggleKeyManualMode.bind(this), showImportance: true, minmaxProps: { flag1: true } }"></ng-container>
            </div>
        </div>
    </div>

    <!-- Maskir Questions -->
    <div *ngIf="mode === 'admin-maskir'" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ניהול שאלון משכיר</h2>
                <button class="btn-close" (click)="close()">X</button>
            </div>
            <div class="modal-body">
                <div class="questions-list">
                    <h3>שאלות קיימות</h3>
                    <div *ngIf="!maskirQuestions.length" style="opacity: 0.6; padding: 1rem;">אין שאלות עדיין.</div>
                    <ng-container *ngFor="let q of maskirQuestions; let i = index">
                        <ng-container
                            *ngTemplateOutlet="questionItem; context: { $implicit: q, index: i, listLen: maskirQuestions.length, moveUpFn: moveQuestionUp.bind(this), moveDownFn: moveQuestionDown.bind(this), openEditFn: openEditQuestion.bind(this), deleteFn: deleteMaskirQuestion.bind(this), togglePublicFn: toggleQuestionPublic.bind(this), showImportance: false, moveArgs: { a: false, b: true }, openArgs: { a: false, b: true } }"></ng-container>
                    </ng-container>
                </div>
                <hr style="margin: 2rem 0; opacity: 0.1;">
                <ng-container
                    *ngTemplateOutlet="addQuestionForm; context: { model: newMaskirQuestion, addOptFn: addMaskirOption.bind(this), removeOptFn: removeMaskirOption.bind(this), addFn: addMaskirQuestion.bind(this), keyManualMode: maskirKeyManualMode, toggleKeyFn: toggleKeyManualMode.bind(this), showImportance: false, minmaxProps: { flag1: false, flag2: true } }"></ng-container>
            </div>
        </div>
    </div>

    <!-- Apartment Questions -->
    <div *ngIf="mode === 'admin-apartment'" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ניהול שאלות לדירה</h2>
                <button class="btn-close" (click)="close()">X</button>
            </div>
            <div class="modal-body">
                <div class="questions-list">
                    <h3>שאלות קיימות</h3>
                    <div *ngIf="!apartmentQuestions.length" style="opacity: 0.6; padding: 1rem;">אין שאלות עדיין.</div>
                    <ng-container *ngFor="let q of apartmentQuestions; let i = index">
                        <ng-container
                            *ngTemplateOutlet="questionItem; context: { $implicit: q, index: i, listLen: apartmentQuestions.length, moveUpFn: moveQuestionUp.bind(this), moveDownFn: moveQuestionDown.bind(this), openEditFn: openEditQuestion.bind(this), deleteFn: deleteApartmentQuestion.bind(this), togglePublicFn: toggleQuestionPublic.bind(this), showImportance: false, moveArgs: { a: false, b: false, c: true }, openArgs: { a: false, b: false, c: true } }"></ng-container>
                    </ng-container>
                </div>
                <hr style="margin: 2rem 0; opacity: 0.1;">
                <ng-container
                    *ngTemplateOutlet="addQuestionForm; context: { model: newApartmentQuestion, addOptFn: addApartmentOption.bind(this), removeOptFn: removeApartmentOption.bind(this), addFn: addApartmentQuestion.bind(this), keyManualMode: apartmentKeyManualMode, toggleKeyFn: toggleKeyManualMode.bind(this), showImportance: false, minmaxProps: { flag1: false, flag2: false, flag3: true } }"></ng-container>
            </div>
        </div>
    </div>


    <!-- === USER / FUNCTIONAL MODALS === -->

    <!-- Fill/Add Apartment Listing -->
    <div *ngIf="mode === 'fill-apartment' || mode === 'add-apartment'" class="modal-overlay">
        <div class="modal-content onboarding-modal">
            <div class="modal-header">
                <h2>{{ editApartment ? 'שינוי פרטי דירה' : 'הוסף דירה למאגר' }}</h2>
                <button class="btn-close" (click)="close()">X</button>
            </div>
            <div class="modal-body">
                <div *ngIf="apartmentQuestions.length; else noApartmentQuestions">
                    <div *ngFor="let q of apartmentQuestions" class="answer-item" style="margin-bottom:1.5rem;">
                        <strong style="display: block; margin-bottom: 0.8rem;">{{ q.text }}</strong>
                        <ng-container
                            *ngTemplateOutlet="answerInput; context: { $implicit: q, model: apartmentAnswers }"></ng-container>
                    </div>

                    <div
                        style="display:flex; justify-content:space-between; margin-top:2rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem;">
                        <button class="btn btn-cancel" (click)="close()">ביטול</button>
                        <button class="btn btn-approve" (click)="submitApartment()">{{ editApartment ? 'עדכן דירה' :
                            'שמור דירה' }}</button>
                    </div>
                </div>
                <ng-template #noApartmentQuestions>
                    <div style="padding:2rem; text-align:center; opacity:0.6;">אין שאלות לדירה במערכת.</div>
                </ng-template>
            </div>
        </div>
    </div>

    <!-- View User Answers (Grid/Card style) -->
    <div *ngIf="mode === 'view-answers'" class="answers-viewer-container">
        <div class="viewer-header" *ngIf="!onlyPersonalQuestions">
            <h2>תשובות משתמש</h2>
            <button class="btn-close" (click)="close()">X</button>
        </div>
        <div class="answers-grid" style="margin-top: 1.5rem;">
            <div *ngIf="!viewedQuestionIds.length" class="empty-state"
                style="padding: 3rem; text-align: center; opacity: 0.5;">לא הוזנו נתונים.</div>
            <div *ngFor="let qid of viewedQuestionIds" class="answer-card-item glass-card" style="padding: 1.2rem;">
                <div class="answer-label"
                    style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.6rem; opacity: 0.8;">{{
                    questionTextMap[qid] || qid }}</div>
                <div class="answer-value" style="font-size: 1.1rem; color: #4caf50;">{{ formatAnswer(viewedUserAnswers ?
                    viewedUserAnswers[qid] : null) || '—' }}</div>
            </div>
        </div>
    </div>

    <!-- Onboarding / Registration Flow -->
    <div *ngIf="mode === 'onboarding' || mode === 'registration'" class="modal-overlay">
        <div class="modal-content onboarding-modal">
            <div class="modal-header">
                <div style="flex:1;">
                    <h2 style="margin: 0;">{{ currentGroupTitle }}</h2>
                    <div style="font-size:0.9rem; color:#888; margin-top:0.4rem;">
                        <span>{{ currentOnboardingProgress }}</span>
                        <span *ngIf="nextGroupPreview"
                            style="margin-right: 0.5rem; color: #555; font-style: italic;">(הבא: {{ nextGroupPreview
                            }})</span>
                    </div>
                </div>
            </div>
            <div class="modal-body" style="padding-top: 1rem;">
                <div *ngIf="currentOnboardingQuestion as q" class="onboarding-step">
                    <h3 class="question-text" style="font-size: 1.5rem; margin-bottom: 2rem; line-height: 1.4;">{{
                        q.text }}</h3>
                    <div class="answer-area" style="margin: 2rem 0;">
                        <ng-container
                            *ngTemplateOutlet="answerInput; context: { $implicit: q, model: onboardingAnswers }"></ng-container>
                    </div>
                </div>

                <div class="onboarding-actions"
                    style="display:flex; justify-content:space-between; margin-top:3rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem;">
                    <button *ngIf="mode === 'onboarding'" class="btn btn-cancel" (click)="close()">ביטול</button>
                    <div style="display: flex; gap: 0.8rem; margin-right: auto;">
                        <button class="btn btn-special" (click)="prevQuestion()"
                            [disabled]="(currentQuestionIndex === 0 && currentQuestionGroup === 0) || (currentQuestionIndex === 0 && currentQuestionGroup === 1 && mode === 'onboarding')">הקודם</button>

                        <button *ngIf="!isLastOnboardingQuestion || !isLastGroup" class="btn btn-approve"
                            (click)="nextQuestion()" [disabled]="!canProceedWithQuestion()">הבא</button>

                        <button *ngIf="isLastOnboardingQuestion && isLastGroup" class="btn btn-approve"
                            (click)="submitOnboardingAnswers()" [disabled]="!canSubmitOnboarding()">סיים ושלח</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Personality Answers -->
    <div *ngIf="mode === 'edit-answers'" class="modal-overlay">
        <div class="modal-content onboarding-modal">
            <div class="modal-header">
                <div style="flex:1;">
                    <h2 style="margin: 0;">ערוך תשובות אישיות</h2>
                    <div style="font-size:0.9rem; color:#888; margin-top:0.45rem;">סך הכל: {{
                        editPersonalityQuestions.length }} שאלות</div>
                </div>
                <button class="btn-close" (click)="cancelEdit()">X</button>
            </div>
            <div class="modal-body">
                <div *ngIf="!editPersonalityQuestions.length" style="padding:3rem; text-align:center; opacity:0.6;">אין
                    שאלות לעריכה.</div>

                <div *ngIf="editPersonalityQuestions.length">
                    <div *ngFor="let q of editPersonalityQuestions; let i = index" class="edit-answer-row glass-card"
                        style="margin-bottom:1rem; padding:1.2rem;">
                        <div style="display:flex; align-items:center; gap:0.8rem; margin-bottom:1rem;">
                            <div
                                style="width:30px; height:30px; border-radius:50%; background:rgba(255,255,255,0.08); display:grid; place-items:center; font-weight:700; font-size:0.9rem;">
                                {{ i + 1 }}</div>
                            <strong style="font-size:1.1rem; opacity: 0.9;">{{ q.text }}</strong>
                        </div>
                        <ng-container
                            *ngTemplateOutlet="answerInput; context: { $implicit: q, model: editPersonalityAnswers }"></ng-container>
                    </div>

                    <div
                        style="display:flex; justify-content:space-between; margin-top:2rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem;">
                        <button class="btn btn-cancel" (click)="cancelEdit()">ביטול</button>
                        <button class="btn btn-approve" (click)="submitEditPersonalityAnswers()"
                            [disabled]="!canSubmitEditAnswers()">שמור שינויים</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Specific Question (Admin) -->
    <div *ngIf="editingQuestion" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ערוך שאלה</h2>
                <button class="btn-close" (click)="closeEditQuestion()">X</button>
            </div>
            <div class="modal-body">
                <ng-container *ngTemplateOutlet="langSwitcher"></ng-container>

                <label>נוסח השאלה ({{currentLang | uppercase}})</label>
                <input *ngIf="currentLang === 'he'" [(ngModel)]="editingQuestion.text" class="form-control input-long"
                    placeholder="הכנס שאלה (עברית)..." />
                <input *ngIf="currentLang === 'en'" [(ngModel)]="editingQuestion.textEn" class="form-control input-long"
                    placeholder="Enter question (English)..." />
                <input *ngIf="currentLang === 'ru'" [(ngModel)]="editingQuestion.textRu" class="form-control input-long"
                    placeholder="Введите вопрос (Russian)..." />
                <input *ngIf="currentLang === 'fr'" [(ngModel)]="editingQuestion.textFr" class="form-control input-long"
                    placeholder="Entrez la question (French)..." />

                <div class="key-section-container" style="margin-top: 1rem; opacity: 0.7;">
                    <label>מפתח (לא ניתן לעריכה)</label>
                    <input [ngModel]="editingQuestion.key" disabled class="form-control input-short" />
                </div>

                <div class="visibility-toggle" [class.active]="editingQuestion.public"
                    (click)="editingQuestion.public = !editingQuestion.public">
                    <div class="switch-track">
                        <div class="switch-thumb">
                            <span class="material-symbols-outlined">{{ editingQuestion.public ? 'visibility' :
                                'visibility_off' }}</span>
                        </div>
                    </div>
                    <div class="toggle-info">
                        <span class="toggle-title">נראות התשובה</span>
                        <span class="toggle-desc">{{ editingQuestion.public ? 'הצג תשובה לכל המשתמשים (גלוי לכולם)' :
                            'שמור תשובה כפרטית' }}</span>
                    </div>
                </div>

                <label>סוג תשובה</label>
                <select [(ngModel)]="editingQuestion.type" class="form-control input-long">
                    <option value="text">טקסט חופשי</option>
                    <option value="yesno">כן/לא</option>
                    <option value="checklist">רשימת אפשרויות</option>
                    <option value="date">תאריך</option>
                    <option value="scale">דירוג</option>
                    <option value="range">טווח מספרים</option>
                    <option value="radio">בחירה יחידה</option>
                    <option value="phone">טלפון</option>
                    <option value="city_neighborhood">עיר ושכונה</option>
                </select>

                <div *ngIf="editingQuestion.type === 'checklist' || editingQuestion.type === 'radio'"
                    class="options-manager" style="margin-top: 1rem;">
                    <label>אפשרויות בחירה</label>
                    <div class="add-option-row" style="margin-top: 0.5rem;">
                        <input [(ngModel)]="editOption" class="form-control" style="flex:1" placeholder="אפשרות חדשה..."
                            (keyup.enter)="addEditOption()" />
                        <button class="btn btn-special btn-sm" (click)="addEditOption()">הוסף</button>
                    </div>
                    <ul class="options-list" style="margin-top: 0.5rem;">
                        <li *ngFor="let opt of editingQuestion.options; let i = index">{{opt}} <span class="remove-opt"
                                (click)="removeEditOption(i)">x</span></li>
                    </ul>
                </div>

                <div *ngIf="editingQuestion.type === 'scale' || editingQuestion.type === 'range'" class="scale-manager"
                    style="display:flex; gap:1rem; margin-top:1rem;">
                    <div style="flex: 1;"><label>מינימום</label><input type="number" [(ngModel)]="editingQuestion.min"
                            class="form-control" /></div>
                    <div style="flex: 1;"><label>מקסימום</label><input type="number" [(ngModel)]="editingQuestion.max"
                            class="form-control" /></div>
                </div>

                <div *ngIf="editingQuestion.type === 'checklist'" class="max-selections-manager"
                    style="margin-top:1rem;">
                    <label>מקסימום בחירות (אופציונלי)</label>
                    <input type="number" [(ngModel)]="editingQuestion.maxSelections" class="form-control input-short"
                        placeholder="ללא הגבלה" min="1" />
                </div>

                <button class="btn btn-approve btn-fit-content" style="margin-top: 2rem;" (click)="updateQuestion()"
                    [disabled]="!editingQuestion.text">שמור שינויים</button>
            </div>
        </div>
    </div>
</div>