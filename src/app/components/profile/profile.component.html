<section class="profile-page">
  <div class="container profile-container">

    <header class="profile-header">
      <div class="header-content">
        <h1>פרופיל משתמש</h1>
        <p class="subtitle">נהל את ההגדרות והמידע האישי שלך</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-cancel" (click)="promptLogout()">
          <span class="material-symbols-outlined">logout</span> התנתק
        </button>
      </div>
    </header>

    <div *ngIf="user$ | async as user; else loggedOut">

      <div *ngIf="isAdmin()" class="admin-badge-container"
        style="display: flex; justify-content: center; margin-bottom: 2rem;">
        <div class="admin-badge">A D M I N</div>
      </div>

      <div class="profile-grid">
        <!-- Main User Card -->
        <div class="glass-card user-main-card">
          <div class="card-glass-effect"></div>
          <div class="user-avatar-section">
            <div class="avatar avatar-xl">
              {{ (profile?.displayName || user.displayName || 'U')[0].toUpperCase() }}
            </div>
          </div>
          <div class="user-info-section">
            <h2 class="display-name">{{ profile?.displayName || (user.displayName || 'משתמש') }}</h2>
            <div class="user-meta">
              <span class="badge" [ngClass]="profile?.role === 'admin' ? 'badge-red' : 'badge-blue'">{{ profile?.role ||
                'user' }}</span>

              <span class="dot-separator">•</span>
              <span class="email-text">{{ profile?.email || user.email }}</span>
            </div>
            <div class="uid-section">
              <span class="label">UID:</span>
              <span class="mono">{{ profile?.uid || user.uid }}</span>
            </div>
            <div class="created-at">
              <span class="material-symbols-outlined" style="font-size: 1.1rem; color: #4caf50;">calendar_today</span>
              נוצר ב-{{ profile?.createdAt | date:'longDate' }}
            </div>
          </div>
        </div>

        <!-- Info Grid (Registration & Personal Answers) -->
        <div class="info-grid">
          <!-- Registration Info Card -->
          <div class="glass-card answers-card">
            <div class="card-header">
              <div class="header-title">
                <span class="material-symbols-outlined">description</span>
                <h3>מידע רישום</h3>
                <span style="color: #ff5252; font-size: 0.85rem; font-weight: 600; margin-right: 0.5rem;">(לא ניתן
                  לערוך)</span>
              </div>
            </div>
            <div class="answers-list">
              <div class="answer-row">
                <div class="label">דוא"ל</div>
                <div class="value">{{ profile?.email || user.email }}</div>
              </div>
              <!-- registration answers -->
              <ng-container *ngIf="profile?.questions as qs">
                <div *ngFor="let item of (qs | keyvalue)">
                  <ng-container *ngIf="hasRegistrationQuestion(item.key)">
                    <div class="answer-row">
                      <div class="label">{{ safeQuestionLabel(item.key) }}</div>
                      <div class="value">{{ formatAnswer(item.value) }}</div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Personal Answers Card -->
          <div class="glass-card answers-card">
            <div class="card-header">
              <div class="header-title">
                <span class="material-symbols-outlined">psychology_alt</span>
                <h3>תשובות אישיות</h3>
              </div>
              <button class="btn btn-approve btn-sm" type="button" (click)="openEditAnswers()"
                *ngIf="!showQuestionsManager">
                <span class="material-symbols-outlined">edit</span> ערוך
              </button>
            </div>
            <div class="answers-list">
              <ng-container *ngIf="profile?.questions as qs">
                <div *ngFor="let item of (qs | keyvalue)">
                  <ng-container *ngIf="hasPersonalQuestion(item.key)">
                    <div class="answer-row">
                      <div class="label">{{ safeQuestionLabel(item.key) }}</div>
                      <div class="value">{{ formatAnswer(item.value) }}</div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
              <div *ngIf="!(profile?.questions | keyvalue)?.length" class="empty-state">
                <p>טרם מילאת תשובות אישיות.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Groups & Invitations Section -->
        <div class="glass-card groups-card" id="groups-management-section">
          <div class="card-header">
            <div class="header-title">
              <span class="material-symbols-outlined">group</span>
              <h3>הקבוצה שלי</h3>
            </div>
          </div>
          <div class="groups-content">
            <div *ngIf="activeGroup; else noGroups" class="active-group-card invitation-item-premium">
              <!-- Group Header -->
              <div class="group-header"
                style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:1rem;">
                <div>
                  <h3 style="margin:0; font-size:1.3rem; color:#fff;">{{ activeGroup.name }}</h3>
                  <p style="margin:0.25rem 0 0 0; color:rgba(255,255,255,0.6); font-size:0.9rem;"
                    *ngIf="activeGroup.description">{{ activeGroup.description }}</p>
                  <div class="meta" style="margin-top:0.5rem; display:flex; gap:1rem; opacity:0.75; font-size:0.85rem;">
                    <span *ngIf="activeGroup.creatorName"><span class="material-symbols-outlined"
                        style="font-size:1rem;vertical-align:middle;">person</span> מנהל: {{ activeGroup.creatorName
                      }}</span>
                    <span><span class="material-symbols-outlined"
                        style="font-size:1rem;vertical-align:middle;">calendar_today</span> נוצרה: {{
                      activeGroup.createdAt?.toDate() | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <div class="group-properties" *ngIf="activeGroup.properties?.length"
                    style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <span *ngFor="let prop of activeGroup.properties"
                      style="background: rgba(76, 175, 80, 0.1); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.3); padding: 0.2rem 0.6rem; border-radius: 100px; font-size: 0.8rem; font-weight: 600;">
                      <span class="material-symbols-outlined"
                        style="font-size: 0.9rem; vertical-align: middle; margin-left: 2px;">star</span>
                      {{ prop }}
                    </span>
                  </div>
                </div>
                <div *ngIf="activeGroup.adminId !== profile?.uid; else creatorGroupMsg">
                  <button class="btn btn-cancel btn-sm" (click)="leaveGroup(activeGroup)" title="צא מהקבוצה">
                    <span class="material-symbols-outlined">logout</span> יציאה
                  </button>
                </div>
                <ng-template #creatorGroupMsg>
                  <span style="font-size: 0.85rem; color: rgba(255,255,255,0.7); font-style: italic;">
                    הקבוצה הזאת נוצרה על ידך - ניהול הקבוצה בדף <a routerLink="/search-groups"
                      style="color: #fff; text-decoration: underline;">חיפוש שותפים</a>
                  </span>
                </ng-template>
              </div>

              <!-- Group Members -->
              <div class="group-members-section">
                <strong style="display:block; margin-bottom:0.75rem; color:rgba(255,255,255,0.9);">חברי הקבוצה ({{
                  activeGroup.fullMembers?.length || activeGroup.members.length }}):</strong>
                <div class="inv-members-grid">
                  <div *ngFor="let member of activeGroup.fullMembers" class="member-mini-card">
                    <div class="member-card-main">
                      <div class="avatar avatar-md">
                        {{ (member.displayName || 'U')[0].toUpperCase() }}
                      </div>
                      <div class="member-details">
                        <span class="name">{{ member.displayName || 'משתמש' }}</span>
                        <!-- Email hidden -->
                        <span class="badge badge-red"
                          *ngIf="(member.uid || member.id) && (member.uid || member.id) === activeGroup.adminId">
                          <span class="material-symbols-outlined" style="font-size: 0.85rem;">verified_user</span> מנהל
                          הקבוצה
                        </span>

                      </div>
                      <button class="btn btn-outline btn-sm" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;"
                        (click)="toggleQuickView(member.uid || member.id)">
                        <span class="material-symbols-outlined" style="font-size: 1rem;">
                          {{ expandedMemberId === (member.uid || member.id) ? 'expand_less' : 'visibility' }}
                        </span>
                      </button>
                    </div>

                    <!-- Unfolding content -->
                    <div class="user-card-unfurl" [class.expanded]="expandedMemberId === (member.uid || member.id)">
                      <div class="unfurl-inner">
                        <div class="unfurl-content-wrapper"
                          *ngIf="expandedMemberId === (member.uid || member.id) || closingMemberId === (member.uid || member.id)">
                          <app-questions-manager mode="view-answers" [userId]="member.uid || member.id"
                            [onlyPersonalQuestions]="false" [showOnlyPublicAnswers]="true"
                            (closed)="toggleQuickView(member.uid || member.id)"></app-questions-manager>
                          <div class="unfurl-footer">
                            <button class="btn btn-outline btn-sm" (click)="toggleQuickView(member.uid || member.id)">
                              <span class="material-symbols-outlined">expand_less</span> סגור תצוגה
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noGroups>
              <div class="empty-state">
                <p>אינך חבר באף קבוצה כרגע.</p>
              </div>
            </ng-template>

            <hr *ngIf="invitations.length > 0">

            <div *ngIf="invitations.length > 0" class="invitations-section">
              <h4>הזמנות ממתינות ({{ invitations.length }})</h4>
              <div class="invitations-list">
                <div *ngFor="let inv of invitations" class="invitation-item-premium">
                  <div class="inv-header">
                    <span class="material-symbols-outlined">mail</span>
                    <span class="group-inv-name">{{ inv.groupName }}</span>
                  </div>
                  <div class="inv-body">
                    <p class="inv-description" *ngIf="inv.groupDescription">
                      <strong>תיאור:</strong> {{ inv.groupDescription }}
                    </p>
                    <div class="inv-created-by" *ngIf="inv.creatorName"
                      style="margin-bottom: 1rem; font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                      <strong>מנהל הקבוצה:</strong> {{ inv.creatorName }}
                    </div>

                    <div class="inv-members" *ngIf="inv.fullMembers && inv.fullMembers.length > 0">
                      <strong>חברי הקבוצה ({{ inv.fullMembers.length }}):</strong>
                      <div class="inv-members-grid">
                        <div *ngFor="let member of inv.fullMembers" class="member-mini-card">
                          <div class="member-card-main">
                            <div class="avatar avatar-md">
                              {{ (member.displayName || 'U')[0].toUpperCase() }}
                            </div>
                            <div class="member-details">
                              <span class="name">{{ member.displayName || 'משתמש' }}</span>

                              <span class="badge badge-red"
                                *ngIf="(member.uid || member.id) && (member.uid || member.id) === inv.adminId">
                                <span class="material-symbols-outlined" style="font-size: 0.85rem;">verified_user</span>
                                מנהל הקבוצה
                              </span>

                            </div>
                            <button class="btn btn-outline btn-sm" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;"
                              (click)="toggleQuickView(member.uid || member.id)">
                              <span class="material-symbols-outlined" style="font-size: 1rem;">
                                {{ expandedMemberId === (member.uid || member.id) ? 'expand_less' : 'visibility' }}
                              </span>
                            </button>
                          </div>

                          <!-- Unfolding Content -->
                          <div class="user-card-unfurl"
                            [class.expanded]="expandedMemberId === (member.uid || member.id)">
                            <div class="unfurl-inner">
                              <div class="unfurl-content-wrapper"
                                *ngIf="expandedMemberId === (member.uid || member.id) || closingMemberId === (member.uid || member.id)">
                                <app-questions-manager mode="view-answers" [userId]="member.uid || member.id"
                                  [onlyPersonalQuestions]="false" [showOnlyPublicAnswers]="true"
                                  (closed)="toggleQuickView(member.uid || member.id)">
                                </app-questions-manager>
                                <div class="unfurl-footer">
                                  <button class="btn btn-outline btn-sm"
                                    (click)="toggleQuickView(member.uid || member.id)">
                                    <span class="material-symbols-outlined" style="font-size: 1rem;">expand_less</span>
                                    סגור תצוגה
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="inv-members" *ngIf="!inv.fullMembers || inv.fullMembers.length === 0">
                      <p class="no-members">טרם הצטרפו חברים לקבוצה זו.</p>
                    </div>
                  </div>
                  <div class="inv-actions">
                    <button class="btn btn-approve btn-sm" (click)="acceptInvitation(inv)">
                      <span class="material-symbols-outlined">check</span> קבל
                    </button>
                    <button class="btn btn-cancel btn-sm" (click)="rejectInvitation(inv)">
                      <span class="material-symbols-outlined">close</span> דחה
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logout Confirmation Overlay -->
      <div *ngIf="showLogoutConfirm" class="confirm-modal-overlay">
        <div class="confirm-modal">
          <h3>התנתקות</h3>
          <p>האם אתה בטוח שברצונך להתנתק מהמערכת?</p>
          <div class="confirm-actions">
            <button class="btn btn-cancel" (click)="confirmLogout()">כן, התנתק</button>
            <button class="btn btn-secondary" (click)="cancelLogout()">ביטול</button>
          </div>
        </div>
      </div>

    </div>

    <ng-template #loggedOut>
      <div class="logged-out-state">
        <span class="material-symbols-outlined"
          style="font-size: 5rem; opacity: 0.2; margin-bottom: 2rem;">no_accounts</span>
        <p>אנא התחבר כדי לצפות בפרופיל האישי שלך.</p>
        <button class="btn btn-approve" (click)="goHome()">חזרה לדף הבית</button>
      </div>
    </ng-template>

    <!-- QUESTIONS MANAGER COMPONENT -->
    <app-questions-manager *ngIf="showQuestionsManager" [mode]="questionsMode" [profile]="profile"
      [userId]="selectedUserId" (completed)="onQuestionsCompleted()" (closed)="onQuestionsClosed()">
    </app-questions-manager>

  </div>
</section>