<section class="profile-page">
  <div class="container profile-container">

    <header class="profile-header">
      <div class="header-content">
        <h1>פרופיל משתמש</h1>
        <p class="subtitle">נהל את ההגדרות והמידע האישי שלך</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-cancel" (click)="promptLogout()">
          <span class="material-symbols-outlined">logout</span> התנתק
        </button>
      </div>
    </header>

    <div *ngIf="user$ | async as user; else loggedOut">

      <!-- Admin Badge (Premium Look) -->
      <div *ngIf="isAdmin()" class="admin-badge-container">
        <div class="admin-badge-premium">A D M I N</div>
      </div>

      <div class="profile-grid">
        <!-- Main User Card -->
        <div class="profile-card user-main-card">
          <div class="card-glass-effect"></div>
          <div class="user-avatar-section">
            <div class="avatar-placeholder">
              {{ (profile?.displayName || user.displayName || 'U')[0].toUpperCase() }}
            </div>
          </div>
          <div class="user-info-section">
            <h2 class="display-name">{{ profile?.displayName || (user.displayName || 'משתמש') }}</h2>
            <div class="user-meta">
              <span class="role-tag">{{ profile?.role || 'user' }}</span>
              <span class="dot-separator">•</span>
              <span class="email-text">{{ profile?.email || user.email }}</span>
            </div>
            <div class="uid-section">
              <span class="label">UID:</span>
              <span class="mono">{{ profile?.uid || user.uid }}</span>
            </div>
            <div class="created-at">
              <span class="material-symbols-outlined" style="font-size: 1.1rem; color: #4caf50;">calendar_today</span>
              נוצר ב-{{ profile?.createdAt | date:'longDate' }}
            </div>
          </div>
        </div>

        <!-- Info Grid (Registration & Personal Answers) -->
        <div class="info-grid">
          <!-- Registration Info Card -->
          <div class="profile-card answers-card">
            <div class="card-header">
              <div class="header-title">
                <span class="material-symbols-outlined">description</span>
                <h3>מידע רישום</h3>
                <span style="color: #ff5252; font-size: 0.85rem; font-weight: 600; margin-right: 0.5rem;">(לא ניתן
                  לערוך)</span>
              </div>
            </div>
            <div class="answers-list">
              <div class="answer-row">
                <div class="label">דוא"ל</div>
                <div class="value">{{ profile?.email || user.email }}</div>
              </div>
              <!-- registration answers -->
              <ng-container *ngIf="profile?.questions as qs">
                <div *ngFor="let item of (qs | keyvalue)">
                  <ng-container *ngIf="hasRegistrationQuestion(item.key)">
                    <div class="answer-row">
                      <div class="label">{{ safeQuestionLabel(item.key) }}</div>
                      <div class="value">{{ formatAnswer(item.value) }}</div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Personal Answers Card -->
          <div class="profile-card answers-card">
            <div class="card-header">
              <div class="header-title">
                <span class="material-symbols-outlined">psychology_alt</span>
                <h3>תשובות אישיות</h3>
              </div>
              <button class="btn btn-approve btn-sm" type="button" (click)="openEditAnswers()"
                *ngIf="!showQuestionsManager">
                <span class="material-symbols-outlined">edit</span> ערוך
              </button>
            </div>
            <div class="answers-list">
              <ng-container *ngIf="profile?.questions as qs">
                <div *ngFor="let item of (qs | keyvalue)">
                  <ng-container *ngIf="hasPersonalQuestion(item.key)">
                    <div class="answer-row">
                      <div class="label">{{ safeQuestionLabel(item.key) }}</div>
                      <div class="value">{{ formatAnswer(item.value) }}</div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
              <div *ngIf="!(profile?.questions | keyvalue)?.length" class="empty-state">
                <p>טרם מילאת תשובות אישיות.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Groups & Invitations Section -->
        <div class="profile-card groups-card" id="groups-management-section">
          <div class="card-header">
            <div class="header-title">
              <span class="material-symbols-outlined">group</span>
              <h3>הקבוצות שלי</h3>
            </div>
          </div>
          <div class="groups-content">
            <div *ngIf="userGroups.length > 0; else noGroups" class="groups-list">
              <div *ngFor="let group of userGroups" class="group-item">
                <span class="material-symbols-outlined">diversity_3</span>
                <span class="group-name">{{ group.name }}</span>
              </div>
            </div>
            <ng-template #noGroups>
              <div class="empty-state">
                <p>אינך חבר באף קבוצה כרגע.</p>
              </div>
            </ng-template>

            <hr *ngIf="invitations.length > 0">

            <div *ngIf="invitations.length > 0" class="invitations-section">
              <h4>הזמנות ממתינות</h4>
              <div class="invitations-list">
                <div *ngFor="let inv of invitations" class="invitation-item">
                  <div class="inv-info">
                    <span class="group-inv-name">{{ inv.groupName }}</span>
                    <span class="inv-text">הזמין אותך להצטרף</span>
                  </div>
                  <div class="inv-actions">
                    <button class="btn btn-approve btn-sm" (click)="acceptInvitation(inv)">קבל</button>
                    <button class="btn btn-cancel btn-sm" (click)="rejectInvitation(inv)">דחה</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logout Confirmation Overlay -->
      <div *ngIf="showLogoutConfirm" class="confirm-modal-overlay">
        <div class="confirm-modal">
          <h3>התנתקות</h3>
          <p>האם אתה בטוח שברצונך להתנתק מהמערכת?</p>
          <div class="confirm-actions">
            <button class="btn btn-cancel" (click)="confirmLogout()">כן, התנתק</button>
            <button class="btn btn-secondary" (click)="cancelLogout()">ביטול</button>
          </div>
        </div>
      </div>

    </div>

    <ng-template #loggedOut>
      <div class="logged-out-state">
        <span class="material-symbols-outlined"
          style="font-size: 5rem; opacity: 0.2; margin-bottom: 2rem;">no_accounts</span>
        <p>אנא התחבר כדי לצפות בפרופיל האישי שלך.</p>
        <button class="btn btn-approve" (click)="goHome()">חזרה לדף הבית</button>
      </div>
    </ng-template>

    <!-- QUESTIONS MANAGER COMPONENT -->
    <app-questions-manager *ngIf="showQuestionsManager" [mode]="questionsMode" [profile]="profile"
      [userId]="selectedUserId" (completed)="onQuestionsCompleted()" (closed)="onQuestionsClosed()">
    </app-questions-manager>

  </div>
</section>